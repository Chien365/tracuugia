<script src="https://unpkg.com/html5-qrcode"></script>

<script>
let productData = {};
let dataReady = false;
let scannerRunning = false;
let html5QrCode;

// Load dữ liệu
fetch('data.csv')
  .then(res => res.text())
  .then(text => {
    const lines = text.trim().split('\n');
    lines.forEach(line => {
      const [barcode, name, stock, price] = line.split(',');
      productData[barcode.trim()] = {
          name: name.trim(),
          stock: stock.trim(),
          price: price.trim() + " VNĐ"
      };
    });
    dataReady = true;
    console.log("Dữ liệu đã load xong!");
  });

// Tìm sản phẩm
function searchProduct() {
    if (!dataReady) return alert("Chờ dữ liệu!");
    const code = document.getElementById('productCode').value.trim();
    const resultDiv = document.getElementById('result');

    if (productData[code]) {
        resultDiv.innerHTML = `
            <b>Tên:</b> ${productData[code].name}<br>
            <b>Số lượng:</b> ${productData[code].stock}<br>
            <b>Giá:</b> ${productData[code].price}
        `;
    } else {
        resultDiv.innerHTML = "Không tìm thấy sản phẩm!";
    }
}

// Mở camera
function startScanner() {
    if (!dataReady) return alert("Chờ dữ liệu!");
    if (scannerRunning) return;

    html5QrCode = new Html5Qrcode("reader");
    scannerRunning = true;

    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
          console.log("Mã quét được: ", decodedText);

          const cleanCode = decodedText.trim();
          document.getElementById('productCode').value = cleanCode;
          searchProduct();

          html5QrCode.stop().then(() => {
              html5QrCode.clear();
              document.getElementById('reader').innerHTML = "";
              scannerRunning = false;
          }).catch(err => console.error("Lỗi dừng camera: ", err));
      },
      (err) => {} // Bỏ log lỗi cho đỡ rối
    ).catch(err => {
      alert("Không mở được camera: " + err);
      scannerRunning = false;
    });
}
</script>
